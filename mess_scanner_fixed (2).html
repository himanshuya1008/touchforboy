<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#ff6b9d" />
  <title>Mess Scanner App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow-x: hidden;
      background: #f5f5f5;
      touch-action: pan-y;
    }

    .screen {
      display: none;
      min-height: 100vh;
      width: 100%;
    }

    .screen.active {
      display: block;
    }

    /* Home Screen */
    #homeScreen {
      background: linear-gradient(135deg, #ff9a76 0%, #ff6b9d 50%, #fdb99b 100%);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
    }

    .back-btn {
      font-size: 24px;
      color: #333;
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px;
    }

    .tabs {
      display: flex;
      gap: 30px;
    }

    .tab {
      font-size: 16px;
      font-weight: 500;
      color: #555;
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px;
    }

    .tab.active {
      color: #000;
    }

    .container {
      padding: 0 20px 40px;
    }

    .student-card {
      background: linear-gradient(135deg, #ff9a76 0%, #ffb347 50%, #ffd700 100%);
      border-radius: 30px;
      padding: 40px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .photo-box {
      width: 160px;
      height: 200px;
      background: white;
      border-radius: 20px;
      margin: 0 auto 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 100px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .student-name {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 30px;
    }

    .info-row {
      margin-bottom: 20px;
    }

    .info-label {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 16px;
      color: #444;
    }

    .meal-card {
      background: white;
      border-radius: 30px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .instruction {
      text-align: center;
      font-size: 20px;
      color: #333;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .meal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .meal-btn {
      background: linear-gradient(135deg, #ffb347 0%, #ffd700 100%);
      border: none;
      border-radius: 20px;
      padding: 25px;
      font-size: 20px;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
      touch-action: manipulation;
    }

    .meal-btn:active {
      transform: scale(0.95);
    }

    .meal-btn.full {
      grid-column: 1 / -1;
    }

    /* Scanner Screen */
    #scannerScreen {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      padding: 20px;
    }

    .scanner-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      color: white;
    }

    .scanner-title {
      font-size: 20px;
      font-weight: 600;
      flex: 1;
      text-align: center;
    }

    .scanner-content {
      max-width: 500px;
      margin: 0 auto;
    }

    .scan-methods {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 30px;
      padding: 30px;
      margin-bottom: 20px;
    }

    .method-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }

    .camera-section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      text-align: center;
    }

    .camera-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 15px;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .camera-btn:active {
      background: #059669;
    }

    .or-divider {
      text-align: center;
      color: #9ca3af;
      margin: 25px 0;
      font-size: 16px;
      font-weight: 500;
    }

    .manual-section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
    }

    .manual-title {
      color: white;
      font-size: 16px;
      margin-bottom: 15px;
      text-align: center;
    }

    .qr-input {
      width: 100%;
      padding: 18px;
      font-size: 16px;
      border: 2px solid #10b981;
      border-radius: 15px;
      background: white;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }

    .submit-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 15px;
      cursor: pointer;
      width: 100%;
      touch-action: manipulation;
    }

    .submit-btn:active {
      background: #059669;
    }

    .test-codes {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 20px;
      margin-top: 20px;
    }

    .test-title {
      color: #10b981;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 15px;
      text-align: center;
    }

    .quick-test-btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .quick-btn {
      background: rgba(16, 185, 129, 0.2);
      border: 2px solid #10b981;
      color: #10b981;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      touch-action: manipulation;
    }

    .quick-btn:active {
      background: rgba(16, 185, 129, 0.4);
    }

    #cameraReader {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      border-radius: 20px;
      overflow: hidden;
    }

    /* Processing Screen */
    #processingScreen {
      background: #1f2937;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .processing-content {
      text-align: center;
    }

    .spinner {
      width: 100px;
      height: 100px;
      border: 8px solid #10b981;
      border-top-color: transparent;
      border-radius: 50%;
      margin: 0 auto 30px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .processing-text {
      font-size: 24px;
      font-weight: 600;
      color: white;
      margin-bottom: 10px;
    }

    .processing-sub {
      font-size: 18px;
      color: #9ca3af;
    }

    /* Meal Pass Screen */
    #mealPassScreen {
      background: #1f2937;
      padding: 20px;
    }

    .pass-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .pass-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .pass-title {
      color: white;
      font-size: 20px;
      font-weight: 500;
      flex: 1;
      text-align: center;
    }

    .close-btn {
      background: #374151;
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      touch-action: manipulation;
    }

    .pass-card {
      background: white;
      border-radius: 30px;
      padding: 40px;
      position: relative;
    }

    .countdown {
      position: absolute;
      top: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: #9ca3af;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .pass-photo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: linear-gradient(135deg, #d1d5db, #9ca3af);
      margin: 20px auto 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      border: 4px solid #d1d5db;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .meal-title {
      font-size: 56px;
      font-weight: bold;
      text-align: center;
      color: #111;
      margin-bottom: 20px;
    }

    .pass-details {
      text-align: center;
      margin-bottom: 30px;
    }

    .student-id {
      font-size: 24px;
      font-weight: bold;
      color: #111;
      margin-bottom: 10px;
    }

    .student-info {
      font-size: 20px;
      font-weight: 600;
      color: #111;
      margin-bottom: 5px;
    }

    .mess-name {
      font-size: 18px;
      color: #555;
    }

    .program-box {
      background: #f3f4f6;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      font-size: 16px;
      color: #111;
      margin-bottom: 30px;
    }

    .datetime {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .datetime-item {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #111;
    }

    .approved-badge {
      background: #10b981;
      color: white;
      padding: 20px 40px;
      border-radius: 20px;
      text-align: center;
      font-size: 32px;
      font-weight: bold;
      margin: 0 auto 40px;
      max-width: fit-content;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    }

    .qr-frame {
      border: 8px solid #7f1d1d;
      border-radius: 30px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .qr-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .green-tick {
      background: #10b981;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    }

    .tick-icon {
      color: white;
      font-size: 100px;
      font-weight: bold;
    }

    .bottom-check {
      display: flex;
      justify-content: center;
    }

    .check-circle {
      background: #10b981;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }

    .check-icon {
      color: white;
      font-size: 50px;
    }

    @media (max-width: 480px) {
      .meal-title {
        font-size: 42px;
      }
      .datetime {
        gap: 20px;
      }
      .datetime-item {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- Home Screen -->
  <div id="homeScreen" class="screen active">
    <div class="header">
      <button class="back-btn">‚Üê</button>
      <div class="tabs">
        <button class="tab active">Mess Coupon</button>
        <button class="tab">Meal History</button>
      </div>
    </div>

    <div class="container">
      <div class="student-card">
        <div class="photo-box">üë§</div>
        <div class="student-name">Bishoyi Rishabh Ranjib</div>

        <div class="info-row">
          <div class="info-label">Father's Name</div>
          <div class="info-value">Ranjib Bishoyi (9082938931)</div>
        </div>

        <div class="info-row">
          <div class="info-label">Mother's Name</div>
          <div class="info-value">Ruby ()</div>
        </div>

        <div class="info-row">
          <div class="info-label">Program Name</div>
          <div class="info-value">P132:B.Tech. (Computer Science and Engineering)(2023)</div>
        </div>

        <div class="info-row">
          <div class="info-label">Hostel</div>
          <div class="info-value">Boys Studios 10- A602-Bed B (Std Non-AC 4 Seater)</div>
        </div>
      </div>

      <div class="meal-card">
        <div class="instruction">Tap on the meal name to<br />scan and avail food.</div>

        <div class="meal-buttons">
          <button class="meal-btn" onclick="selectMeal('BreakFast')">BreakFast ‚Üí</button>
          <button class="meal-btn" onclick="selectMeal('Lunch')">Lunch ‚Üí</button>
          <button class="meal-btn full" onclick="selectMeal('Dinner')">Dinner ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner Screen -->
  <div id="scannerScreen" class="screen">
    <div class="scanner-header">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="scanner-title">Scan QR Code</div>
      <div style="width: 24px"></div>
    </div>

    <div class="scanner-content">
      <div class="scan-methods">
        <div class="method-title">Choose Scan Method</div>

        <!-- Camera Option -->
        <div class="camera-section" id="cameraSection">
          <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
          <div style="color: white; font-size: 16px; margin-bottom: 10px;">Use Camera to Scan</div>
          <div id="cameraReader" style="display: none;"></div>
          <button class="camera-btn" onclick="startCamera()" id="cameraBtn">
            <span>üì∏</span> Open Camera Scanner
          </button>
        </div>

        <div class="or-divider">OR</div>

        <!-- Manual Entry -->
        <div class="manual-section">
          <div style="font-size: 48px; margin-bottom: 10px; text-align: center;">‚å®Ô∏è</div>
          <div class="manual-title">Enter QR Code Manually</div>
          <input type="text" id="manualQRInput" class="qr-input" placeholder="Type QR code here">
          <button class="submit-btn" onclick="submitManualQR()">‚úì Submit Code</button>
        </div>
      </div>

      <!-- Quick Test -->
      <div class="test-codes">
        <div class="test-title">üß™ Quick Test Codes</div>
        <div class="quick-test-btns">
          <button class="quick-btn" onclick="quickTest('QR123')">QR123</button>
          <button class="quick-btn" onclick="quickTest('QR999')">QR999</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Screen -->
  <div id="processingScreen" class="screen">
    <div class="processing-content">
      <div class="spinner"></div>
      <div class="processing-text">Processing...</div>
      <div class="processing-sub">Verifying your meal access</div>
    </div>
  </div>

  <!-- Meal Pass Screen -->
  <div id="mealPassScreen" class="screen">
    <div class="pass-container">
      <div class="pass-header">
        <div></div>
        <div class="pass-title">Mess Pass</div>
        <button class="close-btn" onclick="goHome()">√ó</button>
      </div>

      <div class="pass-card">
        <div class="countdown" id="countdown">30</div>

        <div class="pass-photo">üë§</div>

        <div class="meal-title" id="mealType">BreakFast</div>

        <div class="pass-details">
          <div class="student-id" id="passStudentId">12324343</div>
          <div class="student-info" id="passStudentName">Bishoyi Rishabh Ranjib</div>
          <div class="mess-name" id="passMessName">Mess BS-10</div>
        </div>

        <div class="program-box" id="passProgram">P132:B.Tech. (Computer Science and Engineering)(2023)</div>

        <div class="datetime">
          <div class="datetime-item" id="dateDisplay"></div>
          <div class="datetime-item" id="timeDisplay"></div>
        </div>

        <div class="approved-badge">Meal Approved</div>

        <div class="qr-frame">
          <div class="qr-box">
            <div class="green-tick">
              <div class="tick-icon">‚úì</div>
            </div>
          </div>
        </div>

        <div class="bottom-check">
          <div class="check-circle">
            <div class="check-icon">‚úì</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedMeal = '';
    let html5QrcodeScanner = null;
    let countdownInterval = null;
    let timeUpdateInterval = null;
    let isScanning = false;

    // Mock database
    const mockDatabase = {
      QR123: {
        id: 'STU001',
        name: 'Bishoyi Rishabh Ranjib',
        mess: 'BS-10',
        program: 'P132: B.Tech. (CSE)(2023)',
        status: 'active'
      },
      QR999: {
        id: 'STU999',
        name: 'John Doe',
        mess: 'BS-02',
        program: 'P110: BBA (2022)',
        status: 'active'
      }
    };
    const usedCoupons = {};

    function verifyMealAccess(qrData, mealType) {
      return new Promise((resolve) => {
        setTimeout(() => {
          const record = mockDatabase[qrData];
          if (!record) {
            resolve({ success: false, reason: 'Invalid QR Code' });
            return;
          }
          
          const today = new Date().toDateString();
          const couponKey = `${record.id}-${mealType}-${today}`;
          
          if (usedCoupons[couponKey]) {
            resolve({ success: false, reason: `${mealType} already availed today` });
          } else {
            usedCoupons[couponKey] = true;
            resolve({ success: true, data: record });
          }
        }, 1500);
      });
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach((s) => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function selectMeal(meal) {
      selectedMeal = meal;
      document.getElementById('mealType').textContent = meal;
      showScreen('scannerScreen');
    }

    function startCamera() {
      const cameraReader = document.getElementById('cameraReader');
      const cameraBtn = document.getElementById('cameraBtn');
      
      if (isScanning) return;
      
      cameraReader.style.display = 'block';
      cameraBtn.style.display = 'none';
      
      const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 }
      };
      
      html5QrcodeScanner = new Html5Qrcode('cameraReader');
      isScanning = true;
      
      html5QrcodeScanner
        .start({ facingMode: "environment" }, config, onScanSuccess, () => {})
        .catch((err) => {
          console.error('Camera error:', err);
          isScanning = false;
          cameraReader.style.display = 'none';
          cameraBtn.style.display = 'flex';
          alert('Cannot access camera. Please use manual entry below.');
        });
    }

    async function onScanSuccess(decodedText) {
      if (!isScanning) return;
      isScanning = false;
      
      if (navigator.vibrate) navigator.vibrate(200);
      
      await stopScanner();
      await processQRCode(decodedText.trim());
    }

    async function submitManualQR() {
      const input = document.getElementById('manualQRInput');
      const qrCode = input.value.trim();
      
      if (!qrCode) {
        alert('Please enter a QR code');
        return;
      }
      
      await stopScanner();
      await processQRCode(qrCode);
      input.value = '';
    }

    async function quickTest(qrCode) {
      await stopScanner();
      await processQRCode(qrCode);
    }

    async function processQRCode(qrCode) {
      showProcessing();
      const res = await verifyMealAccess(qrCode, selectedMeal);
      
      if (res.success) {
        fillMealPass(res.data);
        showScreen('mealPassScreen');
        startCountdown();
        startTimeUpdate();
      } else {
        alert(res.reason);
        goHome();
      }
    }

    async function stopScanner() {
      if (html5QrcodeScanner && isScanning) {
        try {
          await html5QrcodeScanner.stop();
        } catch (err) {
          console.error('Error stopping scanner:', err);
        }
        html5QrcodeScanner = null;
        isScanning = false;
      }
      document.getElementById('cameraReader').style.display = 'none';
      document.getElementById('cameraBtn').style.display = 'flex';
    }

    function showProcessing() {
      showScreen('processingScreen');
    }

    function fillMealPass(data) {
      document.getElementById('passStudentId').textContent = data.id;
      document.getElementById('passStudentName').textContent = data.name;
      document.getElementById('passMessName').textContent = `Mess ${data.mess}`;
      document.getElementById('passProgram').textContent = data.program;
      updateDateTime();
    }

    function updateDateTime() {
      const now = new Date();
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const dateStr = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
      
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12;
      const timeStr = `${hours}:${minutes} ${ampm}`;
      
      document.getElementById('dateDisplay').textContent = dateStr;
      document.getElementById('timeDisplay').textContent = timeStr;
    }

    function startTimeUpdate() {
      clearInterval(timeUpdateInterval);
      timeUpdateInterval = setInterval(updateDateTime, 1000);
    }

    function startCountdown() {
      clearInterval(countdownInterval);
      let timeLeft = 30;
      const countdown = document.getElementById('countdown');
      countdown.textContent = timeLeft;
      
      countdownInterval = setInterval(() => {
        timeLeft--;
        countdown.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          goHome();
        }
      }, 1000);
    }

    async function goHome() {
      await stopScanner();
      clearInterval(countdownInterval);
      clearInterval(timeUpdateInterval);
      showScreen('homeScreen');
    }

    async function goBack() {
      await stopScanner();
      document.getElementById('manualQRInput').value = '';
      showScreen('homeScreen');
    }

    window.addEventListener('beforeunload', () => {
      stopScanner();
      clearInterval(countdownInterval);
      clearInterval(timeUpdateInterval);
    });
  </script>
</body>
</html>